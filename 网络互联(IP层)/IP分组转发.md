# IP分组转发

### 路由器将转发信息存储在转发表(FIB)中

> FIB(Forwarding Information Base)是转发表: 存储的是**网络号**与**下一跳地址**的映射关系

#### 举例:

|Dest Network|Next Hop|
|:----:|:----:|
|128.2.0.0|interface 0|
|128.3.0.0|interface 1|
|128.1.0.0|128.2.0.7|
128.4.0.0|128.3.0.1|

p.s. Next Hop项存储的是下一跳的路由器的IP地址,或者就是路由器直连到目的网络的接口

> 路由器接收分组后,通过FIB以及从IP数据报中分离出的目的网络地址来确定下一跳的路由器/直连接口

### 路由类型:

> 特定主机路由:

> 为特定目的主机指明一个路由, 该路由器只为该目的主机提供数据传输服务

> 默认路由(default route)

> 当某地址在路由表中找不到匹配的地址时,采用此出口

> 当一个网络只有很少的对外连接时很有用

> 默认路由可以减少路由表所占用的空间和搜索路由表所用的时间

### 分组转发规则:

(1) 从数据包的首部提取目的主机的IP地址D, 分离出网络地址N

(2) 若N是与此路由器直接相连的某个网络地址(N与自己某接口的网络地址相同), 则把数据包直接交付目的主机D; 否则是间接交付, 执行(3)

(3) 若FIB表中有目的地址为D的特定主机路由, 则把数据包传送给路由表中所指明的下一跳路由器; 否则, 执行(4)

(4) 若FIB表中有到达网络N的理由, 则把数据包传送给路由表指明的下一跳路由器; 否则, 执行(5)

(5) 若FIB表中有一个默认路由, 则把数据包送给路由表中所指明的默认路由器; 否则, 执行(6)

(6) 报告转发分组出错(ICMP, 目的不可达)

### 地址解析协议(Address Resolution Protocol, ARP)

#### 设计原因:

> 主机/路由器的物理接口在转发数据时, 只能理解特定网络的编址方案(硬件地址, 如Mac地址)

> 地址解析: IP地址->硬件地址

> IP数据报在逐跳转发的过程中,每一个结点需要根据本次传输的目的结点IP找到对应的目的结点的硬件地址(仅仅是本跳传输的直接接收结点)

> 随后, 网络适配器把IP数据报封装在目的地址为该硬件地址的帧中, 发往本次传输的目的结点(可能是最终目的地, 也可能是到达最终目的地的中间路由器)

### ARP映射方法:

#### ARP高速缓存(ARP Cache)

> 存储结点所在局域网内各结点的IP地址到其硬件地址的映射表

> 结点A向局域网内另一结点B发送IP报文

> 在其ARP中查看有无B的IP地址, 有则查出其对应的硬件地址, 将此硬件地址写入MAX帧, 通过局域网将该MAC帧发往此硬件地址

> 否则, A向局域网内广播ARP请求, 询问B的IP地址对应的硬件地址

> B收到该请求后, 单播回复自己的硬件地址

> A和B都会将对方地址的映射关系写入ARP Cache

