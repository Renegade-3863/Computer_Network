# 4.1 网际协议IP(Internet Protocol)

## 4.1.0 网络组成回顾:

主要有直连网络和交换网络两大类

交换网络又分分组交换和电路交换两类,其中电路交换由于是面向连接的,实用性和效率都不如分组交换网络,所以目前局域网主要还是采用分组交换,那么如何将小的局域分组交换网拓展到全球范围?

传统的分组交换网络具有类扁平结构,如果要接入更多的端系统,会导致相当庞大的路由交换节点网络,使得路由的寻址算法难以实现

同时,由于各种交换网络的类型并不统一,每种交换网络都有自己的地址模式,介质访问协议以及服务模型等等,故它们之间无法直接进行分组交换(语法不一致,对分组的解释器无法正确解释分组各部分含义)

由此,我们希望在链路层上再封装一个新的层,这个层用于连接各种异构网络,管理局域网之间的所有连接用路由器(个人理解有点像普通话对应于各地的方言?)

这就是网络层:

对上提供统一的网络接口,对下方运输层以及数据链路层采用的各种技术细节进行隐藏和封装。方便使用者理解和开发者进行功能适配

## 4.1.1 IP概述

### IP 设计思路

1. IP向上提供最基本的. 简单的, 灵活的数据传输服务

> 现在大规模应用的IP协议本质上是分组交换网络的一种定义延申,故其仍然具有分组交换网络种的面向分组而不是连接的特性,即在网络之间发送分组时无需先建立连接,而是将分组通过路由网络随机地转发出去,原属于主机同一数据报的不同IP分组可能会经过不同的网络路径最终到达目的主机

2. 尽最大努力交付(best-effort delivery)

> 网络层不提供服务质量的承诺: 

> 意思是由IP层传送的分组可能会出现出错,丢失,重复,乱序等问题,同时IP也不保证分组传送的时限

> 如果需要可靠传输,则应该由主机中的传输层负责, 与路由器(IP层网络节点)无关

> 这就意味着,IP的路由器可以省去多余的差错检测和错误处理模块,从而减轻设计成本, 同时降低IP层协议本身的设计难度

### 与IP相对应的另一种网络层设计思路: 虚电路

IP协议是链路层分组交换在网络层中的延续,相对的,虚电路技术就是电路交换在网络层中的延续

作为电路交换的网际延申,虚电路设计思路自然是一种面向连接的网际通信方式,通过在不同网络间建立虚拟电路,确保一段时间内通信双方在这条虚电路上通信的独占性和可靠性(是的,这种方式会在网络层也确保可靠传输)

不过由于虚电路的设计复杂度高(应用了差错检测,实现了可靠传输,复杂度升高),同时也继承了电路交换的低带宽利用率等等问题,这一技术并未被最终采用

### 互联结点:

路由器/网关(Router/Gateway)

> 网络层功能:

> 通过逐跳的分组转发实现源,目的结点之间的数据传输,基于两种重要的网络层功能实现:

1. 转发: 分组到达路由器的一条输入链路时,路由器必须将该分组移动到适当的输出链路

2. 路由选择: 分组从源结点(发送方)流向接收方(目的结点)时,网络层必须决定这些分组所采用的路由/路径,计算这些路径的算法称为路由选择算法(routing algorithm)

## IP 及相关协议:

### ICMP(网际控制报文协议)(Internet Control Message Protocol)

### IGMP(网际组管理协议)(Internet Group Management Protocol)

### ARP(地址解析协议)(Address Resolution protocol)

### 路由选择协议(Route Selection Protocol)

### IP 地址及其表示方法:

> IP地址(IPv4) 

> 全球唯一的, 32位, 结点标识符

> 表示方式: 点分十进制

> e.g. 机器码

> 10000000000010110000001100011111

> 插入点号提高可读性:

> 1000000.00001011.00000011.00011111

> 每8位转换成10进制数便于使用:

> 128.11.3.31

### IP地址的编址方法:

### 1. 分类的IP地址:

> 分类的IP地址:

> 层次结构: IP地址 = 网络号+主机号

#### 1) 网络号(net-id): 

> 指出结点(主机或路由器)连在哪个网络上

> 所有连到同一网络的结点,其IP地址的网络地址的部分都相同

> 网络号由ICANN分配

> 主机号(host-id): 指出结点在网络内的标识

> 主机号由网络管理员分配

> 分类的IP地址主要有五类:A,B,C类为单播地址;

> D类为多播地址(multicast)

> E类为保留地址(Reserved)

#### A类:

> 形如: 0(1 bit) NetworkID(7 bits) HostID(24 bits)

#### B类:

> 形如: 10(2 bits) NetworkID(14 bits) HostID(16 bits)

#### C类:

> 形如: 110(3 bits) NetworkID(21 bits) HostID(8 bits)

#### D类:

> 形如: 1110(4 bits) Multicast Address(多播地址, 28 bits)

#### E类:

> 形如: 1111(4 bits) Reserved for experiments(保留地址)

***疑问: 为什么五类地址的头部识别码要用到最多4位?***

|网络类别|最大网络数|第一个可用的网络号|最后一个可用的网络号|每个网络中可有的最大主机数|整个IP地址空间的比率|
|----|:----:|:----:|:----:|:----:|:----:|
|A 类|2^7-2|00000001(1.)|01111110(126.)|2^24-2(16777214)|2^31/2^32 = 50%|
|B 类|2^14-1|10000000.00000001(128.1.)|10111111.11111111(191.255.)|2^16-2(65534)|2^30/2^32 = 25%| 
|C 类|2^21-1|11000000.00000000.00000001(192.0.1)|11011111.11111111.11111111(223.255.255.)|2^8-2(254)|2^29/2^32 = 12.5%|

#### 私有IP地址:

除了类似A类网络的环回网络号以及网络号全0的,主机号全0的,以及主机号全1的几类IP地址不进行分配外,还有一些特定的IP地址不进行分配:私有IP地址(private address)

|网络类别|地址范围|所含网络数|
|:----:|:----:|:----:|
|A类|10.0.0.0 ~ 10.255.255.255.255|1
|B类|172.16.0.0 ~ 172.31.255.255|16|
|C类|192.168.0.0 ~ 192.168.255.255|256|

### IP地址采用两层(网络号+主机号)的原因:

#### 1. 方便IP地址管理 

> IP地址管理机构在分配IP地址的时候只分配网络号,剩下的主机号由得到该网络号的单位自行分配

#### 2. 减少路由表存储空间

> 路由器仅根据目的主机所连接的网络号来转发分组(不考虑目的主机号),这样可以将路由表中的项目数大幅度减少

### IP地址实际标识的是一个结点和一条链路的接口

> 当一个结点(主机/路由器)同时连接到两个网络上时,必须同时具有两个相应的IP地址,其网络号必须是不同的--多归属主机(multihomed host)

> 路由器至少应当拥有两个不同的IP地址




